<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Dubbing Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Battambang:wght@400;700&family=Kantumruy+Pro:wght@100..700&family=Moul&family=Nokora:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Kantumruy Pro', sans-serif; -webkit-tap-highlight-color: transparent; }
        /* Custom Scrollbar for mobile */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    </style>
</head>
<body class="bg-[#0f172a] text-white h-screen overflow-hidden">
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;
        const { Upload, Play, Pause, Mic, Type, Palette, Video, Volume2 } = lucide;

        // --- Demo Data ---
        const DEMO_SUBTITLES = [
            { id: 1, start: 1, end: 4, text: "សួស្តី! នេះគឺជាការសាកល្បងលើ Vercel" },
            { id: 2, start: 5, end: 8, text: "កម្មវិធីនេះបង្កើតដោយ React (Single File)" },
            { id: 3, start: 9, end: 12, text: "អ្នកអាចប្រើវាបានដោយគ្មានកុំព្យូទ័រ!" }
        ];

        const FONTS = [
            { name: 'Kantumruy Pro', val: "'Kantumruy Pro', sans-serif" },
            { name: 'Moul', val: "'Moul', serif" },
            { name: 'Battambang', val: "'Battambang', cursive" }
        ];

        function App() {
            const [videoSrc, setVideoSrc] = useState(null);
            const [isPlaying, setIsPlaying] = useState(false);
            const [currentTime, setCurrentTime] = useState(0);
            const [duration, setDuration] = useState(0);
            
            // UI State
            const [selectedFont, setSelectedFont] = useState(FONTS[0].val);
            const [fontSize, setFontSize] = useState(18);
            const [textColor, setTextColor] = useState('#ffffff');
            const [bgColor, setBgColor] = useState('#000000');
            const [voiceEnabled, setVoiceEnabled] = useState(true);

            const videoRef = useRef(null);
            const synth = window.speechSynthesis;
            const lastSpoken = useRef(null);

            useEffect(() => {
                lucide.createIcons();
            }, [videoSrc]);

            const handleFile = (e) => {
                const file = e.target.files[0];
                if(file) setVideoSrc(URL.createObjectURL(file));
            };

            const handleTimeUpdate = () => {
                if(videoRef.current) {
                    const t = videoRef.current.currentTime;
                    setCurrentTime(t);
                    if(voiceEnabled && isPlaying) {
                        const sub = DEMO_SUBTITLES.find(s => t >= s.start && t <= s.end);
                        if(sub && lastSpoken.current !== sub.id) {
                            const u = new SpeechSynthesisUtterance(sub.text);
                            u.lang = 'km-KH';
                            synth.speak(u);
                            lastSpoken.current = sub.id;
                        }
                    }
                }
            };

            const togglePlay = () => {
                if(videoRef.current) {
                    isPlaying ? videoRef.current.pause() : videoRef.current.play();
                    setIsPlaying(!isPlaying);
                }
            };

            const activeSub = DEMO_SUBTITLES.find(s => currentTime >= s.start && currentTime <= s.end);

            return (
                <div className="flex flex-col h-full safe-area-pb">
                    {/* Navbar */}
                    <header className="h-16 bg-slate-900/90 backdrop-blur flex items-center justify-between px-4 border-b border-slate-800 z-50 shrink-0">
                        <div className="flex items-center gap-2 font-bold text-lg bg-clip-text text-transparent bg-gradient-to-r from-pink-400 to-violet-400">
                            <i data-lucide="video" className="w-6 h-6 text-pink-500"></i>
                            Vercel Dubbing
                        </div>
                    </header>

                    {/* Content */}
                    <div className="flex-1 overflow-y-auto bg-black flex flex-col">
                        
                        {/* Video Section */}
                        <div className="relative w-full aspect-[9/16] max-h-[55vh] bg-slate-900 mx-auto shrink-0 border-b border-slate-800">
                            {!videoSrc ? (
                                <div className="flex flex-col items-center justify-center h-full text-slate-400 p-6 text-center">
                                    <div className="w-16 h-16 bg-slate-800 rounded-full flex items-center justify-center mb-6 animate-bounce">
                                        <i data-lucide="upload" className="w-8 h-8 text-pink-500"></i>
                                    </div>
                                    <label className="bg-gradient-to-r from-pink-600 to-violet-600 text-white px-8 py-3 rounded-full font-bold shadow-lg shadow-pink-500/20 active:scale-95 transition cursor-pointer">
                                        ជ្រើសរើសវីដេអូ
                                        <input type="file" accept="video/*" className="hidden" onChange={handleFile} />
                                    </label>
                                </div>
                            ) : (
                                <>
                                    <video 
                                        ref={videoRef} src={videoSrc} 
                                        className="w-full h-full object-contain"
                                        onTimeUpdate={handleTimeUpdate}
                                        onLoadedMetadata={(e) => setDuration(e.target.duration)}
                                        onClick={togglePlay}
                                        playsInline
                                    />
                                    {activeSub && (
                                        <div className="absolute bottom-16 left-4 right-4 text-center pointer-events-none">
                                            <span style={{
                                                fontFamily: selectedFont, color: textColor,
                                                backgroundColor: bgColor + '99', fontSize: fontSize + 'px',
                                                padding: '8px 12px', borderRadius: '8px', lineHeight: '1.5'
                                            }} className="inline-block backdrop-blur-sm shadow-lg transition-all">
                                                {activeSub.text}
                                            </span>
                                        </div>
                                    )}
                                    {!isPlaying && (
                                        <div className="absolute inset-0 flex items-center justify-center bg-black/30 cursor-pointer" onClick={togglePlay}>
                                            <div className="w-16 h-16 bg-white/20 backdrop-blur rounded-full flex items-center justify-center">
                                                <i data-lucide="play" className="w-8 h-8 fill-white text-white ml-1"></i>
                                            </div>
                                        </div>
                                    )}
                                </>
                            )}
                        </div>

                        {/* Controls Section */}
                        <div className="flex-1 bg-slate-900 p-5 space-y-6">
                            
                            {/* Timeline */}
                            {videoSrc && (
                                <div className="flex items-center gap-3 bg-slate-800 p-3 rounded-xl">
                                    <button onClick={togglePlay} className="text-pink-400">
                                        <i data-lucide={isPlaying ? "pause" : "play"} className="w-6 h-6 fill-current"></i>
                                    </button>
                                    <input 
                                        type="range" min="0" max={duration || 100} value={currentTime}
                                        onChange={(e) => {
                                            const t = Number(e.target.value);
                                            videoRef.current.currentTime = t;
                                            setCurrentTime(t);
                                        }}
                                        className="flex-1 h-2 bg-slate-700 rounded-lg appearance-none accent-pink-500"
                                    />
                                </div>
                            )}

                            {/* Voice */}
                            <div className="flex items-center justify-between bg-slate-800 p-4 rounded-xl border border-slate-700">
                                <div className="flex items-center gap-3">
                                    <div className="p-2 bg-pink-500/10 rounded-lg text-pink-400">
                                        <i data-lucide="mic" className="w-5 h-5"></i>
                                    </div>
                                    <span className="font-bold text-sm">សំឡេង AI</span>
                                </div>
                                <div onClick={() => setVoiceEnabled(!voiceEnabled)} className={`w-12 h-7 rounded-full relative transition-colors ${voiceEnabled ? 'bg-pink-600' : 'bg-slate-600'}`}>
                                    <div className={`w-5 h-5 bg-white rounded-full absolute top-1 transition-all shadow-sm ${voiceEnabled ? 'left-6' : 'left-1'}`}></div>
                                </div>
                            </div>

                            {/* Styling */}
                            <div className="bg-slate-800 p-4 rounded-xl border border-slate-700 space-y-4">
                                <div className="flex items-center gap-2 text-violet-400 mb-1">
                                    <i data-lucide="type" className="w-4 h-4"></i>
                                    <span className="font-bold text-sm">រចនាប័ទ្ម</span>
                                </div>
                                
                                <div className="flex gap-2 overflow-x-auto pb-1 no-scrollbar">
                                    {FONTS.map((f, i) => (
                                        <button key={i} onClick={() => setSelectedFont(f.val)} style={{fontFamily: f.val}}
                                            className={`px-4 py-2 rounded-lg text-xs whitespace-nowrap border ${selectedFont === f.val ? 'bg-violet-600 border-violet-500 text-white' : 'bg-slate-900 border-slate-600'}`}>
                                            {f.name}
                                        </button>
                                    ))}
                                </div>

                                <div className="grid grid-cols-2 gap-3">
                                    <div className="bg-slate-900 p-2 rounded-lg border border-slate-600 flex items-center justify-between">
                                        <span className="text-xs text-slate-400">ពណ៌អក្សរ</span>
                                        <input type="color" value={textColor} onChange={(e) => setTextColor(e.target.value)} className="w-6 h-6 bg-transparent rounded cursor-pointer" />
                                    </div>
                                    <div className="bg-slate-900 p-2 rounded-lg border border-slate-600 flex items-center justify-between">
                                        <span className="text-xs text-slate-400">ពណ៌ផ្ទៃ</span>
                                        <input type="color" value={bgColor} onChange={(e) => setBgColor(e.target.value)} className="w-6 h-6 bg-transparent rounded cursor-pointer" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
