<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Khmer AI Video Dubbing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Nokora:wght@400;700&family=Moul&family=Fasthand&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Nokora', sans-serif; }
        .font-moul { font-family: 'Moul', serif; }
        .font-fasthand { font-family: 'Fasthand', cursive; }
    </style>
</head>
<body class="bg-[#0f172a] text-slate-100 min-h-screen">

    <nav class="border-b border-slate-800 bg-slate-900/80 backdrop-blur sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-6 h-16 flex items-center gap-3">
            <i class="fa-solid fa-film text-purple-500 text-xl"></i>
            <h1 class="font-bold text-xl bg-gradient-to-r from-blue-400 to-purple-500 text-transparent bg-clip-text">
                Khmer AI Dubbing <span class="text-xs bg-slate-800 text-slate-400 px-2 py-0.5 rounded ml-2">Ultimate Fix</span>
            </h1>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto p-6 grid grid-cols-1 lg:grid-cols-12 gap-8 mt-4">
        
        <div class="lg:col-span-5 space-y-6">
            <div class="relative border-2 border-dashed border-slate-700 rounded-2xl p-6 bg-slate-800/30 text-center hover:border-purple-500 transition-colors">
                <input type="file" id="videoInput" accept="video/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                <div id="uploadPlaceholder">
                    <i class="fa-solid fa-cloud-arrow-up text-4xl text-slate-500 mb-2"></i>
                    <p class="font-medium text-slate-300">Upload Video</p>
                </div>
                <video id="previewVideo" class="hidden w-full h-40 object-contain rounded-lg mx-auto bg-black" controls></video>
            </div>

            <div class="bg-slate-800/50 p-5 rounded-2xl border border-slate-700 space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs text-slate-400 block mb-1">áŸáŸ†á¡áŸá„ AI</label>
                        <select id="voiceInput" class="w-full bg-slate-900 text-sm p-2 rounded border border-slate-600">
                            <option value="á”áŸ’ášá»áŸ (Male)">á”áŸ’ášá»áŸ (Piseth)</option>
                            <option value="áŸáŸ’ášá¸ (Female)">áŸáŸ’ášá¸ (Sreymom)</option>
                        </select>
                    </div>
                    <div>
                         <label class="text-xs text-slate-400 block mb-1">á—á¶áŸá¶</label>
                         <select id="langInput" class="w-full bg-slate-900 text-sm p-2 rounded border border-slate-600">
                            <option value="á—á¶áŸá¶ááŸ’á˜áŸ‚áš">á—á¶áŸá¶ááŸ’á˜áŸ‚áš</option>
                            <option value="English">English</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs text-slate-400 block mb-1">Font á¢á€áŸ’áŸáš</label>
                        <select id="fontInput" class="w-full bg-slate-900 text-sm p-2 rounded border border-slate-600">
                            <option value="Nokora (á’á˜áŸ’á˜áá¶)">Nokora (á‘á¼á‘áŸ…)</option>
                            <option value="Moul (á¢á€áŸ’áŸášá†áŸ’á›á¶á€áŸ‹)" class="font-moul">Moul (á¢á€áŸ’áŸášá†áŸ’á›á¶á€áŸ‹)</option>
                            <option value="Fasthand (áŸášáŸáŸášáŠáŸƒ)" class="font-fasthand">Fasthand (áŸášáŸáŸášáŠáŸƒ)</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs text-slate-400 block mb-1">áŸáŸ’áá¶á™ (Style)</label>
                        <select id="styleInput" class="w-full bg-slate-900 text-sm p-2 rounded border border-slate-600">
                            <option value="Outline (á˜á¶á“á‚áŸ‚á˜)">Outline (á˜á¶á“á‚áŸ‚á˜)</option>
                            <option value="Box (áŠá¶á€áŸ‹á”áŸ’ášá¢á”áŸ‹)">Box (áŠá¶á€áŸ‹á”áŸ’ášá¢á”áŸ‹)</option>
                        </select>
                    </div>
                </div>

                <div class="flex items-center gap-3">
                    <div class="flex-1">
                         <label class="text-xs text-slate-400 block mb-1">á–ááŸŒ</label>
                         <input type="color" id="colorInput" value="#FFD700" class="w-full h-9 rounded bg-transparent cursor-pointer">
                    </div>
                    <div class="flex-[2]">
                        <label class="text-xs text-slate-400 block mb-1">á‘áŸ†á áŸ† (<span id="sizeValue">50</span>)</label>
                        <input type="range" id="sizeInput" min="20" max="100" value="50" class="w-full h-2 bg-slate-700 rounded-lg accent-purple-500">
                    </div>
                </div>
            </div>

            <button id="processBtn" class="w-full py-3.5 rounded-xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 hover:shadow-lg hover:shadow-purple-500/30 text-white transition-all">
                ğŸš€ á…á¶á”áŸ‹á•áŸ’áá¾á˜ (Start)
            </button>
        </div>

        <div class="lg:col-span-7 bg-slate-900 rounded-3xl border border-slate-800 p-6 flex flex-col justify-center relative min-h-[500px]">
            
            <div id="progressContainer" class="hidden absolute inset-0 z-20 bg-slate-900/95 flex flex-col items-center justify-center p-10 backdrop-blur-sm rounded-3xl">
                <div class="w-full max-w-md space-y-4 text-center">
                    <div class="flex justify-between text-sm font-medium">
                        <span class="text-purple-400 animate-pulse" id="progressStatus">á€áŸ†á–á»á„ Upload...</span>
                        <span class="text-slate-400" id="progressPercent">0%</span>
                    </div>
                    <div class="w-full bg-slate-800 rounded-full h-4 overflow-hidden shadow-inner border border-slate-700">
                        <div id="progressBar" class="bg-gradient-to-r from-blue-500 to-purple-500 h-full rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <p id="errorMessage" class="hidden text-red-400 bg-red-900/20 p-3 rounded-lg text-sm mt-4 border border-red-800"></p>
                    <button id="retryBtn" class="hidden px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm mt-2">áŸá¶á€á˜áŸ’áá„á‘áŸ€á</button>
                </div>
            </div>

            <div id="emptyResult" class="text-center opacity-40">
                <i class="fa-solid fa-clapperboard text-6xl text-slate-700 mb-4"></i>
                <p>á›á‘áŸ’á’á•á›áœá¸áŠáŸá¢á¼á“á¹á„á”á„áŸ’á á¶á‰á“áŸ…á‘á¸á“áŸáŸ‡</p>
            </div>

            <div id="resultContainer" class="hidden flex flex-col items-center w-full h-full">
                <video id="resultVideo" class="w-full max-h-[450px] bg-black rounded-lg shadow-2xl border border-slate-700" controls></video>
                <a id="downloadLink" href="#" download class="mt-6 px-8 py-3 bg-green-600 hover:bg-green-500 text-white rounded-full font-bold shadow-lg flex items-center gap-2 transition-transform hover:scale-105">
                    <i class="fa-solid fa-download"></i> Save Video
                </a>
            </div>
        </div>
    </main>

    <script type="module">
        import { client } from "https://cdn.jsdelivr.net/npm/@gradio/client/+esm";

        // ==========================================
        // âš ï¸ áŠá¶á€áŸ‹áˆáŸ’á˜áŸ„áŸ‡ Space ášá”áŸáŸ‹á¢áŸ’á“á€á“áŸ…á‘á¸á“áŸáŸ‡
        const SPACE_NAME = "monsela/khmer-video-translator"; 
        // ==========================================

        const els = {
            video: document.getElementById('videoInput'),
            preview: document.getElementById('previewVideo'),
            placeholder: document.getElementById('uploadPlaceholder'),
            btn: document.getElementById('processBtn'),
            progressBox: document.getElementById('progressContainer'),
            bar: document.getElementById('progressBar'),
            status: document.getElementById('progressStatus'),
            percent: document.getElementById('progressPercent'),
            resultBox: document.getElementById('resultContainer'),
            videoOut: document.getElementById('resultVideo'),
            empty: document.getElementById('emptyResult'),
            dl: document.getElementById('downloadLink'),
            errorMsg: document.getElementById('errorMessage'),
            retryBtn: document.getElementById('retryBtn')
        };

        let selectedFile = null;

        els.video.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(file){
                selectedFile = file;
                els.preview.src = URL.createObjectURL(file);
                els.preview.classList.remove('hidden');
                els.placeholder.classList.add('hidden');
            }
        });

        document.getElementById('sizeInput').addEventListener('input', (e) => document.getElementById('sizeValue').innerText = e.target.value);
        els.retryBtn.addEventListener('click', () => { window.location.reload(); });

        els.btn.addEventListener('click', async () => {
            if(!selectedFile) return alert("áŸá¼á˜áŠá¶á€áŸ‹áœá¸áŠáŸá¢á¼!");

            // Reset UI
            els.btn.disabled = true;
            els.progressBox.classList.remove('hidden');
            els.resultBox.classList.add('hidden');
            els.empty.classList.remove('hidden');
            els.errorMsg.classList.add('hidden');
            els.retryBtn.classList.add('hidden');
            
            els.bar.style.width = "5%";
            els.status.innerText = "á€áŸ†á–á»á„á—áŸ’á‡á¶á”áŸ‹á‘áŸ… Server...";
            els.status.className = "text-purple-400 animate-pulse";

            try {
                const app = await client(SPACE_NAME);
                
                const inputs = [
                    selectedFile,
                    document.getElementById('langInput').value,
                    document.getElementById('colorInput').value,
                    parseInt(document.getElementById('sizeInput').value),
                    document.getElementById('voiceInput').value,
                    document.getElementById('fontInput').value,
                    document.getElementById('styleInput').value
                ];

                const submission = app.submit("/predict", inputs);

                for await (const msg of submission) {
                    if (msg.type === "status") {
                        if(msg.stage === "pending") {
                            els.status.innerText = "á€áŸ†á–á»á„ášá„áŸ‹á…á¶áŸ†áœáŸá“ (Queue)...";
                        } else if(msg.progress_data) {
                            const p = msg.progress_data[0];
                            if(p) {
                                const pct = Math.round(p.progress * 100) + "%";
                                els.bar.style.width = pct;
                                els.percent.innerText = pct;
                                if(p.desc) els.status.innerText = p.desc;
                            }
                        }
                    } else if (msg.type === "data") {
                        // ğŸ”¥ á€á“áŸ’á›áŸ‚á„á€áŸ‚áŸáŸ†áá¶á“áŸ‹: á–á·á“á·ááŸ’á™á˜á¾á›áá¶á˜á¶á“áœá¸áŠáŸá¢á¼á¬á¢ááŸ‹?
                        if (msg.data && msg.data[0] && msg.data[0].url) {
                            // á‡áŸ„á‚á‡áŸá™
                            const videoUrl = msg.data[0].url;
                            els.videoOut.src = videoUrl;
                            els.dl.href = videoUrl;
                            els.resultBox.classList.remove('hidden');
                            els.empty.classList.add('hidden');
                            els.videoOut.play();
                            els.progressBox.classList.add('hidden');
                        } else {
                            // á”ášá¶á‡áŸá™ (Backend return None)
                            throw new Error(msg.data[1] || "Unknown error from server");
                        }
                        els.btn.disabled = false;
                    }
                }

            } catch (error) {
                console.error(error);
                // á”á„áŸ’á á¶á‰ Error á›á¾ UI ááŸ‚á˜áŸ’áá„
                els.status.innerText = "á”ášá¶á‡áŸá™!";
                els.status.className = "text-red-500 font-bold";
                els.bar.className = "bg-red-600 h-full rounded-full";
                els.errorMsg.innerText = "Error: " + error.message;
                els.errorMsg.classList.remove('hidden');
                els.retryBtn.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>
