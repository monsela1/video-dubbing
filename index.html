import React, { useState, useRef, useEffect } from 'react';
import { Upload, Play, Pause, Mic, Type, Palette, Download, Volume2, Video, Globe, Music, Layers } from 'lucide-react';

// Mock Data for Demo
const DEMO_SUBTITLES = [
  { id: 1, start: 1, end: 4, text: "សួស្តី! នេះគឺជាការសាកល្បងបកប្រែវីដេអូ។" },
  { id: 2, start: 5, end: 8, text: "សូមស្វាគមន៍មកកាន់ AI Dubbing Studio!" },
  { id: 3, start: 9, end: 12, text: "បច្ចេកវិទ្យានេះជួយអ្នកបង្កើតវីដេអូបានលឿន។" },
  { id: 4, start: 13, end: 16, text: "សាកល្បងប្តូរពណ៌ និង Font អក្សរមើល៍!" }
];

const FONTS = [
  { name: 'Kantumruy Pro', val: "'Kantumruy Pro', sans-serif" },
  { name: 'Moul', val: "'Moul', serif" },
  { name: 'Battambang', val: "'Battambang', cursive" },
  { name: 'Nokora', val: "'Nokora', sans-serif" }
];

const VOICES = [
  { id: 'f1', name: 'នារី (Google)', lang: 'km-KH', pitch: 1.2 },
  { id: 'm1', name: 'បុរស (Google)', lang: 'km-KH', pitch: 0.8 },
  { id: 'en', name: 'English (US)', lang: 'en-US', pitch: 1 }
];

export default function App() {
  const [videoSrc, setVideoSrc] = useState(null);
  const [isPlaying, setIsPlaying] = useState(false);
  const [currentTime, setCurrentTime] = useState(0);
  const [duration, setDuration] = useState(0);
  
  // Style State
  const [subtitleText, setSubtitleText] = useState(DEMO_SUBTITLES);
  const [selectedFont, setSelectedFont] = useState(FONTS[0].val);
  const [textColor, setTextColor] = useState('#ffffff');
  const [bgColor, setBgColor] = useState('#000000');
  const [bgOpacity, setBgOpacity] = useState(0.6);
  const [fontSize, setFontSize] = useState(24);
  const [voiceEnabled, setVoiceEnabled] = useState(true);

  const videoRef = useRef(null);
  const lastSpokenRef = useRef(null);

  // Load Google Fonts dynamically
  useEffect(() => {
    const link = document.createElement('link');
    link.href = "https://fonts.googleapis.com/css2?family=Battambang:wght@400;700&family=Kantumruy+Pro:wght@100..700&family=Moul&family=Nokora:wght@400;700&display=swap";
    link.rel = "stylesheet";
    document.head.appendChild(link);
  }, []);

  const handleFile = (e) => {
    const file = e.target.files[0];
    if (file) {
      const url = URL.createObjectURL(file);
      setVideoSrc(url);
      setIsPlaying(false);
    }
  };

  const handleTimeUpdate = () => {
    if(videoRef.current) {
      const t = videoRef.current.currentTime;
      setCurrentTime(t);

      if(voiceEnabled && isPlaying) {
        const sub = subtitleText.find(s => t >= s.start && t <= s.end);
        if(sub && lastSpokenRef.current !== sub.id) {
          speak(sub.text);
          lastSpokenRef.current = sub.id;
        }
      }
    }
  };

  const speak = (text) => {
    if ('speechSynthesis' in window) {
      window.speechSynthesis.cancel();
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = 'km-KH';
      utter.rate = 0.9;
      
      if(videoRef.current) videoRef.current.volume = 0.2;
      
      utter.onend = () => {
        if(videoRef.current) videoRef.current.volume = 1;
      };
      
      window.speechSynthesis.speak(utter);
    }
  };

  const togglePlay = () => {
    if(videoRef.current) {
      if(isPlaying) {
        videoRef.current.pause();
        window.speechSynthesis.cancel();
      } else {
        videoRef.current.play();
      }
      setIsPlaying(!isPlaying);
    }
  };

  const activeSub = subtitleText.find(s => currentTime >= s.start && currentTime <= s.end);

  return (
    <div className="min-h-screen bg-[#0f172a] text-white font-sans selection:bg-pink-500 overflow-hidden flex flex-col">
      {/* Header */}
      <header className="h-16 border-b border-slate-800 bg-[#0f172a]/95 backdrop-blur flex items-center justify-between px-6 z-50">
        <div className="flex items-center gap-2">
          <div className="bg-gradient-to-r from-pink-500 to-violet-600 p-2 rounded-lg shadow-lg shadow-pink-500/20">
            <Video className="w-5 h-5 text-white" />
          </div>
          <h1 className="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-pink-400 to-violet-400 font-['Kantumruy_Pro']">
            AI Dubbing Studio
          </h1>
        </div>
        <div className="flex gap-3">
            <button className="px-4 py-2 text-xs font-medium bg-slate-800 rounded-full border border-slate-700 hover:bg-slate-700 transition">
                Tutorial
            </button>
            <button className="px-4 py-2 text-xs font-bold bg-white text-black rounded-full hover:bg-gray-200 transition flex items-center gap-2">
                <Globe className="w-3 h-3" /> Deploy
            </button>
        </div>
      </header>

      <div className="flex-1 flex overflow-hidden">
        {/* Left: Preview Area */}
        <div className="flex-1 bg-black/40 flex flex-col items-center justify-center relative p-4 lg:p-8">
          
          {!videoSrc ? (
            <div className="text-center p-10 rounded-3xl border border-slate-700 bg-slate-900/80 backdrop-blur-sm max-w-md w-full shadow-2xl">
              <div className="w-16 h-16 bg-slate-800 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-inner">
                <Upload className="w-8 h-8 text-pink-500" />
              </div>
              <h2 className="text-2xl font-bold mb-2 font-['Kantumruy_Pro']">បញ្ចូលវីដេអូរបស់អ្នក</h2>
              <p className="text-slate-400 mb-8 text-sm font-['Kantumruy_Pro']">គាំទ្រវីដេអូ TikTok, Shorts, Reels ឬវីដេអូធម្មតា។</p>
              <label className="cursor-pointer group relative inline-flex items-center justify-center px-8 py-3 font-bold text-white transition-all duration-200 bg-gradient-to-r from-pink-600 to-violet-600 rounded-full focus:outline-none hover:shadow-lg hover:shadow-pink-500/40 transform hover:-translate-y-1">
                <span className="mr-2">Upload Video</span>
                <Upload className="w-4 h-4" />
                <input type="file" accept="video/*" className="hidden" onChange={handleFile} />
              </label>
            </div>
          ) : (
            <div className="relative h-full max-h-[80vh] aspect-[9/16] bg-black rounded-2xl overflow-hidden shadow-2xl border border-slate-800 ring-1 ring-white/10">
              <video 
                ref={videoRef}
                src={videoSrc}
                className="w-full h-full object-contain"
                onTimeUpdate={handleTimeUpdate}
                onLoadedMetadata={(e) => setDuration(e.target.duration)}
                onClick={togglePlay}
                playsInline
              />

              {/* Dynamic Subtitle Overlay */}
              {activeSub && (
                <div className="absolute bottom-24 left-4 right-4 text-center pointer-events-none transition-all duration-300">
                  <span 
                    style={{
                      fontFamily: selectedFont,
                      color: textColor,
                      backgroundColor: `${bgColor}${Math.floor(bgOpacity * 255).toString(16).padStart(2,'0')}`,
                      fontSize: `${fontSize}px`,
                      boxShadow: '0 8px 32px rgba(0,0,0,0.2)',
                      padding: '8px 16px',
                      borderRadius: '12px',
                      lineHeight: '1.6'
                    }}
                    className="inline-block backdrop-blur-md"
                  >
                    {activeSub.text}
                  </span>
                </div>
              )}

              {/* Play Button Overlay */}
              {!isPlaying && (
                <div className="absolute inset-0 flex items-center justify-center bg-black/30 backdrop-blur-[2px] cursor-pointer group" onClick={togglePlay}>
                  <div className="w-20 h-20 bg-white/10 backdrop-blur-xl rounded-full flex items-center justify-center border border-white/20 shadow-2xl group-hover:scale-110 transition-transform duration-300">
                    <Play className="w-8 h-8 text-white fill-white ml-1" />
                  </div>
                </div>
              )}
            </div>
          )}

          {/* Floating Timeline */}
          {videoSrc && (
            <div className="absolute bottom-6 left-1/2 -translate-x-1/2 w-[90%] max-w-xl bg-slate-900/90 backdrop-blur-md border border-slate-700 p-4 rounded-2xl shadow-2xl flex items-center gap-4 z-20">
              <button onClick={togglePlay} className="p-2 hover:bg-slate-700 rounded-full text-pink-400 transition">
                {isPlaying ? <Pause className="w-6 h-6 fill-current" /> : <Play className="w-6 h-6 fill-current" />}
              </button>
              <div className="flex-grow flex flex-col justify-center">
                 <input 
                  type="range" 
                  min="0" max={duration || 100} 
                  value={currentTime}
                  onChange={(e) => {
                    const t = parseFloat(e.target.value);
                    videoRef.current.currentTime = t;
                    setCurrentTime(t);
                  }}
                  className="w-full h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-pink-500 hover:accent-pink-400 transition-all"
                />
              </div>
              <span className="text-xs font-mono text-slate-300 min-w-[3rem] text-right">{Math.floor(currentTime)}s</span>
            </div>
          )}
        </div>

        {/* Right: Sidebar Controls */}
        <div className="w-[400px] bg-[#1e293b] border-l border-slate-800 flex flex-col z-10 shadow-2xl">
            <div className="p-6 overflow-y-auto custom-scrollbar h-full space-y-8">
                
                {/* Voice Control Section */}
                <div className="bg-slate-800/50 rounded-2xl p-5 border border-slate-700/50">
                    <div className="flex items-center justify-between mb-4">
                        <div className="flex items-center gap-2 text-pink-400">
                            <Mic className="w-5 h-5" />
                            <h3 className="font-bold text-base font-['Kantumruy_Pro']">សំឡេង AI (Dubbing)</h3>
                        </div>
                        <label className="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" checked={voiceEnabled} onChange={() => setVoiceEnabled(!voiceEnabled)} className="sr-only peer" />
                            <div className="w-11 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-500"></div>
                        </label>
                    </div>
                    
                    <div className="space-y-2">
                        {VOICES.map(v => (
                            <button key={v.id} className="w-full text-left px-4 py-3 rounded-xl bg-slate-900 border border-slate-700 hover:border-pink-500/50 hover:bg-slate-800 transition flex items-center justify-between group">
                                <span className="text-sm font-['Kantumruy_Pro']">{v.name}</span>
                                {voiceEnabled && <Volume2 className="w-4 h-4 text-slate-600 group-hover:text-pink-400" />}
                            </button>
                        ))}
                    </div>
                </div>

                {/* Typography Control Section */}
                <div className="bg-slate-800/50 rounded-2xl p-5 border border-slate-700/50 space-y-5">
                    <div className="flex items-center gap-2 text-violet-400">
                        <Type className="w-5 h-5" />
                        <h3 className="font-bold text-base font-['Kantumruy_Pro']">រចនាអក្សរ (Style)</h3>
                    </div>

                    {/* Font Family */}
                    <div className="grid grid-cols-2 gap-2">
                        {FONTS.map((f, i) => (
                            <button 
                                key={i}
                                onClick={() => setSelectedFont(f.val)}
                                style={{fontFamily: f.val}}
                                className={`px-3 py-2.5 rounded-lg text-sm border transition truncate ${selectedFont === f.val ? 'bg-violet-600 border-violet-500 text-white shadow-lg shadow-violet-500/20' : 'bg-slate-900 border-slate-700 text-slate-400 hover:bg-slate-800'}`}
                            >
                                {f.name}
                            </button>
                        ))}
                    </div>

                    {/* Color Controls */}
                    <div className="flex gap-3">
                         <div className="flex-1 space-y-2">
                            <label className="text-[10px] uppercase tracking-wider text-slate-400 font-semibold">Color</label>
                            <div className="h-10 bg-slate-900 rounded-xl border border-slate-700 flex items-center px-2 gap-2 cursor-pointer hover:border-slate-500 transition relative overflow-hidden">
                                <div className="w-6 h-6 rounded-full border border-white/20 shadow-sm" style={{backgroundColor: textColor}}></div>
                                <input type="color" value={textColor} onChange={(e) => setTextColor(e.target.value)} className="absolute inset-0 opacity-0 cursor-pointer w-full h-full" />
                                <span className="text-xs text-slate-300 font-mono">{textColor}</span>
                            </div>
                         </div>
                         <div className="flex-1 space-y-2">
                            <label className="text-[10px] uppercase tracking-wider text-slate-400 font-semibold">Background</label>
                            <div className="h-10 bg-slate-900 rounded-xl border border-slate-700 flex items-center px-2 gap-2 cursor-pointer hover:border-slate-500 transition relative overflow-hidden">
                                <div className="w-6 h-6 rounded-full border border-white/20 shadow-sm" style={{backgroundColor: bgColor}}></div>
                                <input type="color" value={bgColor} onChange={(e) => setBgColor(e.target.value)} className="absolute inset-0 opacity-0 cursor-pointer w-full h-full" />
                                <span className="text-xs text-slate-300 font-mono">{bgColor}</span>
                            </div>
                         </div>
                    </div>

                    {/* Sliders */}
                    <div className="space-y-4 pt-2">
                        <div>
                            <div className="flex justify-between text-xs text-slate-400 mb-2">
                                <span className="font-medium">Size</span>
                                <span className="bg-slate-700 px-1.5 rounded text-white">{fontSize}px</span>
                            </div>
                            <input type="range" min="16" max="60" value={fontSize} onChange={(e) => setFontSize(e.target.value)} className="w-full h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-violet-500 hover:accent-violet-400" />
                        </div>
                        <div>
                            <div className="flex justify-between text-xs text-slate-400 mb-2">
                                <span className="font-medium">Opacity</span>
                                <span className="bg-slate-700 px-1.5 rounded text-white">{Math.round(bgOpacity*100)}%</span>
                            </div>
                            <input type="range" min="0" max="1" step="0.1" value={bgOpacity} onChange={(e) => setBgOpacity(e.target.value)} className="w-full h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-violet-500 hover:accent-violet-400" />
                        </div>
                    </div>
                </div>

                {/* Export Button */}
                <button className="mt-auto w-full py-4 bg-gradient-to-r from-pink-600 to-violet-600 rounded-xl font-bold text-white shadow-lg shadow-pink-500/20 hover:shadow-pink-500/40 transition-all transform hover:-translate-y-0.5 active:scale-95 flex items-center justify-center gap-2">
                    <Download className="w-5 h-5" />
                    <span className="font-['Kantumruy_Pro']">រក្សាទុកវីដេអូ (Export)</span>
                </button>
            </div>
        </div>
      </div>
    </div>
  );
}
